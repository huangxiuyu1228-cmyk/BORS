<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HBC-BORS 湖北银行开门红业绩系统</title>
    <!-- 核心库 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        :root {
            --apple-red: #FF3B30;
            --apple-bg: #F5F5F7;
            --apple-card: #FFFFFF;
            --apple-text: #1D1D1F;
            --apple-gray: #86868B;
            --apple-sep: #E5E5EA;
            --safe-bottom: env(safe-area-inset-bottom);
            --border-radius: 32px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--apple-bg);
            color: var(--apple-text);
            line-height: 1.4;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* --- 动画 --- */
        @keyframes rippleWave {
            0% { background-position: 0% 0%; }
            50% { background-position: 100% 100%; }
            100% { background-position: 0% 0%; }
        }
        @keyframes colorfulGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- 登录界面 --- */
        #auth-screen {
            position: fixed;
            inset: 0;
            z-index: 2000;
            background: radial-gradient(circle at top left, #4facfe 0%, #00f2fe 30%, #a8edea 60%, #fed6e3 100%);
            background-size: 200% 200%;
            animation: rippleWave 10s ease-in-out infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .auth-card {
            width: 100%;
            max-width: 360px;
            text-align: center;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(25px);
            padding: 40px 30px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.1);
        }

        /* --- 主架构 --- */
        header {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: saturate(180%) blur(20px);
            z-index: 1000;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 0.5px solid var(--apple-sep);
        }

        .screen {
            display: none;
            padding: 20px;
            padding-bottom: 120px;
            max-width: 600px;
            margin: 0 auto;
        }
        .screen.active { display: block; animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

        .card {
            background: var(--apple-card);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            border: 0.5px solid rgba(0,0,0,0.05);
            width: 100%;
            overflow: hidden;
        }

        .colorful-card {
            background: linear-gradient(-45deg, #FF3CAC, #784BA0, #2B86C5, #00DBDE);
            background-size: 400% 400%;
            animation: colorfulGradient 8s ease infinite;
            color: white !important;
            border: none;
        }
        .colorful-card input, .colorful-card select {
            background: rgba(255, 255, 255, 0.2) !important;
            border: none !important;
            color: white !important;
        }
        .colorful-card input::placeholder { color: rgba(255,255,255,0.6); }

        input, select, textarea {
            width: 100%;
            padding: 14px 16px;
            background: #F2F2F7;
            border: 1.5px solid transparent;
            border-radius: 16px;
            font-size: 16px;
            outline: none;
            max-width: 100%; /* 防止日期框等组件溢出 */
        }

        /* 悬浮通知 */
        #notification-fab {
            position: fixed;
            right: 24px;
            bottom: 108px;
            width: 60px;
            height: 60px;
            background: var(--apple-red);
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 8px 24px rgba(255, 59, 48, 0.3);
            z-index: 1000;
            cursor: pointer;
        }
        .badge {
            position: absolute;
            top: 0;
            right: 0;
            background: white;
            color: var(--apple-red);
            font-size: 12px;
            font-weight: 800;
            width: 22px;
            height: 22px;
            border-radius: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--apple-red);
        }

        /* 底部导航 */
        nav.bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 84px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(25px);
            border-top: 0.5px solid var(--apple-sep);
            display: flex;
            justify-content: space-around;
            padding-bottom: var(--safe-bottom);
            z-index: 1000;
        }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #A1A1A6; font-size: 10px; font-weight: 600; }
        .nav-item.active { color: var(--apple-red); }

        .btn-primary { width: 100%; padding: 16px; background: var(--apple-red); color: white; border: none; border-radius: 18px; font-size: 17px; font-weight: 700; cursor: pointer; }
        .btn-secondary { width: 100%; padding: 16px; background: #F2F2F7; color: var(--apple-text); border: none; border-radius: 18px; font-size: 17px; font-weight: 700; cursor: pointer; }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            backdrop-filter: blur(8px);
            z-index: 3000;
            display: none;
            align-items: flex-end;
            justify-content: center;
        }
        .modal-content {
            background: #FFFFFF;
            width: 100%;
            max-width: 500px;
            border-radius: 40px 40px 0 0;
            padding: 24px;
            padding-bottom: calc(32px + var(--safe-bottom));
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 92vh;
            overflow-y: auto;
        }
        .modal-overlay.active { display: flex; }
        .modal-overlay.active .modal-content { transform: translateY(0); }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- 登录注册页 -->
    <div id="auth-screen">
        <div class="auth-card">
            <img src="https://images-eds-ssl.xboxlive.com/image?url=4rt9.lXDC4H_93laV1_eHHFT949fUipzkiFOBH3fAiZZUCdYojwUyX2aTonS1aIwMrx6NUIsHfUHSLzjGJFxxvtwvrt3JIhC0LNLrK_oJO8kh19fTjTSJb8vb7DjgYAi7LWZ0KeNOxyarooHGNzm8T0qE3e87NA38Ko.ME5t7Ag-&format=webp&h=210" 
                 alt="HBC Logo" style="width: 64px; height: 64px; border-radius: 16px; margin-bottom: 20px;">
            <h1 style="font-size: 28px; font-weight: 800; letter-spacing: 1px; color: #1D1D1F;">HBC-BORS</h1>
            <p style="font-size: 14px; font-weight: 600; color: #48484A; margin-bottom: 30px;">湖北银行开门红业绩系统</p>
            <div id="auth-box">
                <input type="text" id="auth-empid" placeholder="员工工号" style="margin-bottom:12px; background:white;">
                <input type="text" id="auth-name" placeholder="姓名" style="margin-bottom:12px; background:white;">
                <input type="password" id="auth-pwd" placeholder="密码" style="margin-bottom:20px; background:white;">
                <button class="btn-primary" onclick="handleAuth()">注册 / 登录</button>
            </div>
        </div>
    </div>

    <!-- 主界面 -->
    <div id="app-container" style="display:none; opacity:0;">
        <header>
            <div style="display: flex; align-items: center; gap: 10px;">
                <img src="https://images-eds-ssl.xboxlive.com/image?url=4rt9.lXDC4H_93laV1_eHHFT949fUipzkiFOBH3fAiZZUCdYojwUyX2aTonS1aIwMrx6NUIsHfUHSLzjGJFxxvtwvrt3JIhC0LNLrK_oJO8kh19fTjTSJb8vb7DjgYAi7LWZ0KeNOxyarooHGNzm8T0qE3e87NA38Ko.ME5t7Ag-&format=webp&h=210" 
                     alt="Logo" style="width: 32px; height: 32px; border-radius: 8px; object-fit: cover;">
                <div>
                    <h2 style="font-size: 15px; font-weight: 800;">湖北银行开门红业绩系统</h2>
                    <p style="font-size: 9px; color: var(--apple-gray); font-weight: 800; letter-spacing: 0.5px;">HBC-BORS</p>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="text-align: right;">
                    <p id="user-display-name" style="font-size: 13px; font-weight: 700;"></p>
                    <button onclick="logout()" style="border:none; background:none; color: var(--apple-red); font-size: 10px; font-weight: 700;">退出登录</button>
                </div>
                <div style="width: 36px; height: 36px; background: #E5E5EA; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #8E8E93;">
                    <i data-lucide="user-round" size="20"></i>
                </div>
            </div>
        </header>

        <!-- 数据看板 -->
        <section id="screen-dashboard" class="screen active">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                <div class="card" style="padding:20px; margin:0;"><span style="font-size:11px; font-weight:700; color:var(--apple-gray);">累计业绩 (万)</span><div id="stat-total" style="font-size:24px; font-weight:800; color:var(--apple-red);">0.00</div></div>
                <div class="card" style="padding:20px; margin:0;"><span style="font-size:11px; font-weight:700; color:var(--apple-gray);">今日新增 (万)</span><div id="stat-today-new" style="font-size:24px; font-weight:800; color:#34C759;">0.00</div></div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr; margin-bottom: 16px;">
                <div class="card" style="padding:20px; margin:0;"><span style="font-size:11px; font-weight:700; color:var(--apple-gray);">今日转存 (万)</span><div id="stat-today-re" style="font-size:24px; font-weight:800; color:#FF9500;">0.00</div></div>
            </div>
            
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                    <h3 style="font-size:15px; font-weight:700;">业绩趋势 (近一周)</h3>
                    <div style="display:flex; gap:6px;">
                        <input type="date" id="trend-start" style="padding:6px; font-size:10px; width:auto;" onchange="initTrendChart()">
                        <input type="date" id="trend-end" style="padding:6px; font-size:10px; width:auto;" onchange="initTrendChart()">
                    </div>
                </div>
                <div style="height: 220px;"><canvas id="trendChart"></canvas></div>
            </div>
            <div class="card"><h3 style="font-size:15px; font-weight:700; margin-bottom:20px;">资产配置分布</h3><div style="height: 200px;"><canvas id="typeChart"></canvas></div></div>
        </section>

        <!-- 业务明细 -->
        <section id="screen-biz" class="screen">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h2 style="font-size: 24px; font-weight: 800;">业务明细</h2>
                <div style="display:flex; gap:6px;"><input type="date" id="biz-start" style="padding:6px; font-size:10px; width:auto;" onchange="renderBizList()"><input type="date" id="biz-end" style="padding:6px; font-size:10px; width:auto;" onchange="renderBizList()"></div>
            </div>
            <div id="biz-list-container"></div>
        </section>

        <!-- 业务录入 -->
        <section id="screen-add" class="screen">
            <div class="card">
                <h2 style="font-size: 20px; font-weight: 800; margin-bottom: 24px;">新业务录入</h2>
                <div class="input-group" style="margin-bottom:12px;"><span style="font-size:11px; font-weight:700; color:var(--apple-gray); margin-left:4px;">选择客户</span><select id="form-cust-id"></select></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px;">
                    <div class="input-group"><span style="font-size:11px; font-weight:700; color:var(--apple-gray); margin-left:4px;">业务品种</span><select id="form-type">
                        <option>1年定期存款</option><option>2年定期存款</option><option>3年定期存款</option><option>5年定期存款</option>
                        <option>理财产品</option><option>1天通知存款</option><option>7天通知存款</option>
                    </select></div>
                    <div class="input-group"><span style="font-size:11px; font-weight:700; color:var(--apple-gray); margin-left:4px;">业务性质</span><select id="form-nature"><option>新增</option><option>转存</option></select></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:12px;">
                    <div class="input-group"><span style="font-size:11px; font-weight:700; color:var(--apple-gray); margin-left:4px;">金额 (万)</span><input type="number" id="form-amount" placeholder="0.00"></div>
                    <div class="input-group"><span style="font-size:11px; font-weight:700; color:var(--apple-gray); margin-left:4px;">办理日期</span><input type="date" id="form-date"></div>
                </div>
                <button class="btn-primary" onclick="submitTransaction()">确认录入业绩</button>
            </div>
        </section>

        <!-- 客户管理 -->
        <section id="screen-cust" class="screen">
            <div class="card colorful-card">
                <h2 style="font-size: 18px; font-weight: 800; margin-bottom: 20px;">快速新增客户</h2>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;"><input type="text" id="cust-name" placeholder="客户姓名"><select id="cust-gender"><option value="">性别</option><option>男</option><option>女</option></select></div>
                <div style="display:grid; grid-template-columns: 1fr; gap:10px; margin-bottom:10px;"><input type="text" id="cust-idcard" placeholder="身份证号"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;"><input type="text" id="cust-code" placeholder="客户号"><input type="tel" id="cust-phone" placeholder="联系电话"></div>
                <button class="btn-primary" onclick="submitCustomer()" style="background: white; color: #1D1D1F;">保存档案</button>
            </div>
            <div id="cust-list-container"></div>
        </section>

        <!-- 系统工具 -->
        <section id="screen-more" class="screen">
            <div class="card">
                <h3 style="font-size:17px; font-weight:800; margin-bottom:20px;">操作指南与说明</h3>
                <div class="list-item" onclick="openGuide()" style="padding:16px 0; border-bottom:0.5px solid var(--apple-sep); display:flex; justify-content:space-between; align-items:center; cursor:pointer;"><div style="display:flex; align-items:center; gap:12px;"><i data-lucide="book-open" size="20"></i><span style="font-weight:600;">系统使用指南</span></div><i data-lucide="chevron-right" size="18" color="#CCC"></i></div>
                <div class="list-item" onclick="openAbout()" style="padding:16px 0; border-bottom:0.5px solid var(--apple-sep); display:flex; justify-content:space-between; align-items:center; cursor:pointer;"><div style="display:flex; align-items:center; gap:12px;"><i data-lucide="info" size="20"></i><span style="font-weight:600;">关于 HBC-BORS</span></div><i data-lucide="chevron-right" size="18" color="#CCC"></i></div>
                <div class="list-item" onclick="exportCSV()" style="padding:16px 0; border-bottom:0.5px solid var(--apple-sep); display:flex; justify-content:space-between; align-items:center; cursor:pointer;"><div style="display:flex; align-items:center; gap:12px;"><i data-lucide="file-spreadsheet" size="20"></i><span style="font-weight:600;">导出 CSV 报表</span></div><i data-lucide="chevron-right" size="18" color="#CCC"></i></div>
                <div class="list-item" onclick="exportJSON()" style="padding:16px 0; border-bottom:0.5px solid var(--apple-sep); display:flex; justify-content:space-between; align-items:center; cursor:pointer;"><div style="display:flex; align-items:center; gap:12px;"><i data-lucide="database" size="20"></i><span style="font-weight:600;">本地数据备份</span></div><i data-lucide="chevron-right" size="18" color="#CCC"></i></div>
                <div class="list-item" onclick="triggerImport()" style="padding:16px 0; display:flex; justify-content:space-between; align-items:center; cursor:pointer;"><div style="display:flex; align-items:center; gap:12px;"><i data-lucide="upload-cloud" size="20"></i><span style="font-weight:600;">本地数据导入</span></div><input type="file" id="import-file" style="display:none" accept=".json" onchange="handleImport(event)"><i data-lucide="chevron-right" size="18" color="#CCC"></i></div>
            </div>
            <div style="text-align:center; padding:20px 0;"><p style="font-size:10px; color:#C7C7CC; margin-top:4px;">© 2026 黄修宇独立制作</p></div>
        </section>

        <!-- 悬浮通知 -->
        <div id="notification-fab" onclick="toggleNotificationCenter()"><i data-lucide="bell" size="28"></i><span class="badge" id="noti-badge">0</span></div>

        <!-- 底部导航 -->
        <nav class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('dashboard', this)"><i data-lucide="layout-grid"></i><span>数据看板</span></div>
            <div class="nav-item" onclick="switchTab('biz', this)"><i data-lucide="list"></i><span>业务明细</span></div>
            <div class="nav-item" onclick="switchTab('add', this)"><i data-lucide="plus-circle" size="28"></i><span>业务录入</span></div>
            <div class="nav-item" onclick="switchTab('cust', this)"><i data-lucide="users"></i><span>客户管理</span></div>
            <div class="nav-item" onclick="switchTab('more', this)"><i data-lucide="settings"></i><span>系统工具</span></div>
        </nav>
    </div>

    <!-- 弹窗容器 -->
    <div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" id="modal-body"></div>
    </div>

    <script>
        // --- 数据初始化与持久化 ---
        const today = new Date().toISOString().split('T')[0];
        const formatDate = (d) => d.toISOString().split('T')[0];

        let users = JSON.parse(localStorage.getItem('hbc_v83_users') || '[]');
        let customers = JSON.parse(localStorage.getItem('hbc_v83_customers') || '[]');
        let transactions = JSON.parse(localStorage.getItem('hbc_v83_transactions') || '[]');
        let currentUser = JSON.parse(localStorage.getItem('hbc_v83_session') || 'null');

        if(customers.length === 0) {
            customers = [
                { id: 'C1', name: '张建国', gender: '男', idCard: '420106198501011234', custCode: 'HB001', phone: '13812345678' },
                { id: 'C2', name: '李晓丽', gender: '女', idCard: '420103199201014321', custCode: 'HB002', phone: '13900001111' },
                { id: 'C3', name: '王志伟', gender: '男', idCard: '420111197501015678', custCode: 'HB003', phone: '13788889999' }
            ];
            transactions = [
                { id: 1, customerId: 'C1', bType: '3年定期存款', amount: 200, date: today, nature: '新增' }
            ];
            saveData();
        }

        let trendChart, typeChart;

        window.onload = () => {
            lucide.createIcons();
            Chart.register(ChartDataLabels);
            if (currentUser) showApp();
            updateNotifications();
            document.getElementById('form-date').valueAsDate = new Date();
        };

        // --- 核心业务函数 ---
        function getExpiryDate(dateStr, bType) {
            const date = new Date(dateStr);
            let years = parseInt(bType) || 0;
            if (years === 0) return null;
            date.setFullYear(date.getFullYear() + years);
            return formatDate(date);
        }

        function handleAuth() {
            const empId = document.getElementById('auth-empid').value;
            const name = document.getElementById('auth-name').value;
            const pwd = document.getElementById('auth-pwd').value;
            if(!empId || !name || !pwd) return alert('信息不全');
            let user = users.find(u => u.empId === empId);
            if(!user) {
                user = { empId, name, password: pwd };
                users.push(user);
                localStorage.setItem('hbc_v83_users', JSON.stringify(users));
            } else if(user.password !== pwd) return alert('验证失败');
            currentUser = user;
            localStorage.setItem('hbc_v83_session', JSON.stringify(user));
            showApp();
        }

        function showApp() {
            document.getElementById('auth-screen').style.transform = 'translateY(-100%)';
            document.getElementById('app-container').style.display = 'block';
            setTimeout(() => document.getElementById('app-container').style.opacity = '1', 100);
            document.getElementById('user-display-name').innerText = currentUser.name;
            renderDashboard();
            updateFormSelectors();
            renderCustList();
        }

        function logout() { localStorage.removeItem('hbc_v83_session'); location.reload(); }

        function saveData() { 
            localStorage.setItem('hbc_v83_customers', JSON.stringify(customers)); 
            localStorage.setItem('hbc_v83_transactions', JSON.stringify(transactions)); 
            updateNotifications();
        }

        // --- 看板逻辑 ---
        function renderDashboard() {
            const total = transactions.reduce((s,t)=>s+t.amount,0);
            const tStr = new Date().toISOString().split('T')[0];
            const todayTxs = transactions.filter(t => t.date === tStr);
            const todayNew = todayTxs.filter(t => t.nature === '新增').reduce((s,t)=>s+t.amount,0);
            const todayRe = todayTxs.filter(t => t.nature === '转存').reduce((s,t)=>s+t.amount,0);

            document.getElementById('stat-total').innerText = total.toFixed(2);
            document.getElementById('stat-today-new').innerText = todayNew.toFixed(2);
            document.getElementById('stat-today-re').innerText = todayRe.toFixed(2);
            
            initTrendChart();
            initTypeChart();
        }

        function initTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            let dates = [];
            let amounts = [];
            
            // 生成默认近一周日期
            for(let i=6; i>=0; i--) {
                let d = new Date();
                d.setDate(d.getDate() - i);
                dates.push(formatDate(d));
            }

            amounts = dates.map(d => transactions.filter(t => t.date === d).reduce((s,t)=>s+t.amount,0));

            if(trendChart) trendChart.destroy();
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates.map(d => d.slice(5)),
                    datasets: [{
                        data: amounts,
                        borderColor: '#FF3B30',
                        backgroundColor: 'rgba(255, 59, 48, 0.05)',
                        fill: true, tension: 0.4, borderWidth: 3, pointRadius: 5, pointBackgroundColor: '#FFF'
                    }]
                },
                options: {
                    plugins: { legend: { display: false }, datalabels: { align: 'top', color: '#FF3B30', font: { weight: 'bold', size: 10 } } },
                    scales: { y: { display: false }, x: { grid: { display: false } } },
                    maintainAspectRatio: false
                }
            });
        }

        function initTypeChart() {
            const ctx = document.getElementById('typeChart').getContext('2d');
            const types = {};
            transactions.forEach(t => types[t.bType] = (types[t.bType] || 0) + t.amount);
            const total = Object.values(types).reduce((a,b)=>a+b, 0);

            if(typeChart) typeChart.destroy();
            typeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(types),
                    datasets: [{ data: Object.values(types), backgroundColor: ['#FF3B30','#FF9500','#007AFF','#34C759','#AF52DE','#5856D6','#FF2D55'] }]
                },
                options: {
                    cutout: '70%',
                    plugins: {
                        legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10, weight: 'bold' } } },
                        datalabels: {
                            color: '#FFF', font: { weight: 'bold', size: 9 },
                            formatter: (val) => total > 0 ? ((val/total)*100).toFixed(1) + '%' : ''
                        }
                    },
                    maintainAspectRatio: false
                }
            });
        }

        // --- 业务明细管理 ---
        function renderBizList() {
            const start = document.getElementById('biz-start').value;
            const end = document.getElementById('biz-end').value;
            let filtered = transactions;
            if(start) filtered = filtered.filter(t => t.date >= start);
            if(end) filtered = filtered.filter(t => t.date <= end);

            const container = document.getElementById('biz-list-container');
            container.innerHTML = filtered.slice().reverse().map(t => {
                const c = customers.find(cust => cust.id === t.customerId);
                const exp = getExpiryDate(t.date, t.bType);
                return `<div class="card" onclick="openBizEdit('${t.id}')">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div>
                            <span style="font-size:10px; background:#F2F2F7; padding:2px 10px; border-radius:100px; font-weight:700;">${t.nature} · ${t.bType}</span>
                            <p style="font-weight:800; font-size:17px; margin-top:6px;">${c ? c.name : '未知'}</p>
                            <p style="font-size:11px; color:#999; margin-top:4px;">办理日期: ${t.date}</p>
                            ${exp ? `<p style="font-size:11px; color:var(--apple-red); font-weight:700;">到期日期: ${exp}</p>` : ''}
                        </div>
                        <p style="font-size:22px; font-weight:800; color:var(--apple-red);">${t.amount}万</p>
                    </div>
                </div>`;
            }).join('');
        }

        function openBizEdit(id) {
            const t = transactions.find(tx => tx.id == id);
            const body = document.getElementById('modal-body');
            body.innerHTML = `
                <div style="width: 40px; height: 5px; background: #EEE; border-radius: 10px; margin: 0 auto 20px;"></div>
                <h2 style="font-size:22px; font-weight:800; margin-bottom:24px;">修改业务信息</h2>
                <div class="input-group" style="margin-bottom:12px;"><span style="font-size:11px; font-weight:700; color:#999;">修改金额 (万)</span><input type="number" id="edit-tx-amount" value="${t.amount}"></div>
                <div class="input-group" style="margin-bottom:24px;"><span style="font-size:11px; font-weight:700; color:#999;">修改日期</span><input type="date" id="edit-tx-date" value="${t.date}"></div>
                <div style="display:flex; gap:12px;">
                    <button class="btn-secondary" style="color:red; flex:1;" onclick="deleteBizConfirm(${id})">删除</button>
                    <button class="btn-primary" style="flex:2;" onclick="saveBizEdit(${id})">保存修改</button>
                </div>
            `;
            document.getElementById('modal-overlay').classList.add('active');
        }

        function saveBizEdit(id) {
            const t = transactions.find(tx => tx.id == id);
            t.amount = parseFloat(document.getElementById('edit-tx-amount').value);
            t.date = document.getElementById('edit-tx-date').value;
            saveData(); renderBizList(); renderDashboard(); closeModal();
        }

        function deleteBizConfirm(id) {
            if(confirm('确定删除该笔业务业绩？')) {
                transactions = transactions.filter(t => t.id != id);
                saveData(); renderBizList(); renderDashboard(); closeModal();
            }
        }

        // --- 客户管理逻辑 ---
        function submitCustomer() {
            const name = document.getElementById('cust-name').value;
            const phone = document.getElementById('cust-phone').value;
            if(!name || !phone) return alert('姓名与电话不能为空');
            customers.push({ 
                id: 'C' + Date.now(), name, phone, 
                gender: document.getElementById('cust-gender').value, 
                idCard: document.getElementById('cust-idcard').value, 
                custCode: document.getElementById('cust-code').value 
            });
            saveData(); updateFormSelectors(); renderCustList();
            document.getElementById('cust-name').value = '';
            document.getElementById('cust-phone').value = '';
        }

        function renderCustList() {
            const container = document.getElementById('cust-list-container');
            container.innerHTML = customers.slice().reverse().map(c => `
                <div class="card" onclick="openCustDetail('${c.id}')" style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
                    <div><p style="font-weight:700; font-size:17px;">${c.name}</p><p style="font-size:12px; color:#999;">${c.phone}</p></div>
                    <i data-lucide="chevron-right" size="20" color="#CCC"></i>
                </div>`).join('');
            lucide.createIcons();
        }

        function openCustDetail(id) {
            const c = customers.find(cust => cust.id === id);
            const myTxs = transactions.filter(t => t.customerId === id);
            const body = document.getElementById('modal-body');
            body.innerHTML = `
                <div style="width: 40px; height: 5px; background: #EEE; border-radius: 10px; margin: 0 auto 20px;"></div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                    <h2 style="font-size:26px; font-weight:800;">客户档案</h2>
                    <button onclick="deleteCustConfirm('${c.id}')" style="background:#F2F2F7; border:none; padding:8px; border-radius:12px; color:red; cursor:pointer;"><i data-lucide="user-minus" size="18"></i></button>
                </div>
                <div style="background:#F2F2F7; padding:24px; border-radius:28px; margin-bottom:24px;">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                        <div><p style="font-size:11px; color:#999; font-weight:700;">姓名</p><input id="edit-c-name" value="${c.name}"></div>
                        <div><p style="font-size:11px; color:#999; font-weight:700;">性别</p><select id="edit-c-gender"><option ${c.gender==='男'?'selected':''}>男</option><option ${c.gender==='女'?'selected':''}>女</option></select></div>
                    </div>
                    <div style="margin-bottom:12px;"><p style="font-size:11px; color:#999; font-weight:700;">手机号</p><input id="edit-c-phone" value="${c.phone}"></div>
                    <div style="margin-bottom:12px;"><p style="font-size:11px; color:#999; font-weight:700;">身份证号</p><input id="edit-c-id" value="${c.idCard}"></div>
                    <div><p style="font-size:11px; color:#999; font-weight:700;">客户号</p><input id="edit-c-code" value="${c.custCode}"></div>
                    <button class="btn-primary" style="margin-top:16px; font-size:14px; padding:12px;" onclick="saveCustEdit('${c.id}')">保存资料修改</button>
                </div>
                <h3 style="font-size:16px; font-weight:800; margin-bottom:12px;">名下业务列表</h3>
                ${myTxs.map(t => `<div style="padding:10px 0; border-bottom:1px solid #EEE; display:flex; justify-content:space-between;"><span>${t.bType}</span><b>${t.amount}万</b></div>`).join('')}
            `;
            document.getElementById('modal-overlay').classList.add('active');
            lucide.createIcons();
        }

        function saveCustEdit(id) {
            const c = customers.find(cust => cust.id === id);
            c.name = document.getElementById('edit-c-name').value;
            c.gender = document.getElementById('edit-c-gender').value;
            c.phone = document.getElementById('edit-c-phone').value;
            c.idCard = document.getElementById('edit-c-id').value;
            c.custCode = document.getElementById('edit-c-code').value;
            saveData(); renderCustList(); updateFormSelectors(); closeModal();
        }

        function deleteCustConfirm(id) {
            if(confirm('注销客户将同步清空其名下所有业务流水，确定注销？')) {
                customers = customers.filter(c => c.id !== id);
                transactions = transactions.filter(t => t.customerId !== id);
                saveData(); renderCustList(); updateFormSelectors(); closeModal();
            }
        }

        // --- 系统工具 ---
        function exportCSV() {
            let csv = "\ufeff姓名,客户号,手机号,业务日期,业务类型,业务金额(万)\n";
            transactions.forEach(t => {
                const c = customers.find(cust => cust.id === t.customerId);
                csv += `${c?c.name:'未知'},${c?c.custCode:'--'},${c?c.phone:'--'},${t.date},${t.bType},${t.amount}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = '湖北银行开门红业绩报表.csv'; a.click();
        }

        function exportJSON() {
            const blob = new Blob([JSON.stringify({ customers, transactions }, null, 2)], { type: 'application/json' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'HBC_BORS_BACKUP.json'; a.click();
        }

        function triggerImport() { document.getElementById('import-file').click(); }
        function handleImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (data.customers && data.transactions) {
                        if(confirm('导入将覆盖当前所有数据，是否继续？')) {
                            customers = data.customers; transactions = data.transactions; saveData(); location.reload();
                        }
                    }
                } catch (err) { alert('导入失败'); }
            };
            reader.readAsText(file);
        }

        // --- 辅助功能 ---
        function updateNotifications() {
            const list = []; const today = new Date();
            customers.forEach(c => {
                if(!c.idCard || c.idCard.length < 14) return;
                const bStr = c.idCard.slice(10, 14);
                const bDate = new Date(`${today.getFullYear()}-${bStr.slice(0,2)}-${bStr.slice(2,4)}`);
                const diff = Math.ceil((bDate - today) / 86400000);
                if([0, 1, 3, 7].includes(diff)) list.push({ type: 'birthday', customerId: c.id, name: c.name, days: diff });
            });
            transactions.forEach(t => {
                const exp = getExpiryDate(t.date, t.bType); if(!exp) return;
                const diff = Math.ceil((new Date(exp) - today) / 86400000);
                if([0, 1, 3, 7].includes(diff)) list.push({ type: 'expiry', customerId: t.customerId, name: customers.find(c=>c.id===t.customerId)?.name, days: diff, bType: t.bType });
            });
            document.getElementById('noti-badge').innerText = list.length;
            window.activeNotis = list;
        }

        function toggleNotificationCenter() {
            const body = document.getElementById('modal-body');
            const list = window.activeNotis || [];
            body.innerHTML = `
                <div style="width: 40px; height: 5px; background: #EEE; border-radius: 10px; margin: 0 auto 20px;"></div>
                <h2 style="font-size:22px; font-weight:800; margin-bottom:20px;">智能通知中心</h2>
                ${list.length === 0 ? '<p style="text-align:center; color:#CCC; padding:40px;">暂无即将到来的提醒</p>' : 
                    list.map(n => `
                    <div class="card" onclick="openCustDetail('${n.customerId}')" style="display:flex; align-items:center; gap:16px; margin-bottom:12px; border-left:4px solid ${n.type==='birthday'?'#FF9500':'#FF3B30'}; cursor:pointer;">
                        <div style="flex:1;">
                            <p style="font-weight:800; font-size:15px;">${n.name} - ${n.type==='birthday'?'客户生日':'存款到期'}</p>
                            <p style="font-size:12px; color:#999;">${n.days===0?'今天':n.days+'天后'} ${n.type==='expiry'?'('+n.bType+')':''}</p>
                        </div>
                        <i data-lucide="chevron-right" size="18" color="#CCC"></i>
                    </div>`).join('')}
            `;
            document.getElementById('modal-overlay').classList.add('active');
            lucide.createIcons();
        }

        function openGuide() {
            const body = document.getElementById('modal-body');
            body.innerHTML = `
                <div style="width: 40px; height: 5px; background: #EEE; border-radius: 10px; margin: 0 auto 20px;"></div>
                <h2 style="font-size:24px; font-weight:800; margin-bottom:20px;">操作指南</h2>
                <div style="font-size:14px; line-height:1.8; color:#48484A;">
                    <p><b>1. 客户建档：</b>在“客户管理”中点击快速新增，输入手机号和身份证（系统会自动识别生日）。</p>
                    <p><b>2. 业务录入：</b>录入时选择“新增”或“转存”。看板将根据性质分别统计今日战果。</p>
                    <p><b>3. 动态趋势：</b>看板自动补全近一周日期，业绩波动一目了然。</p>
                    <p><b>4. 业务编辑：</b>在业务明细点击任意记录，即可修正金额或办理日期。</p>
                </div>
            `;
            document.getElementById('modal-overlay').classList.add('active');
        }

        function openAbout() {
            const body = document.getElementById('modal-body');
            body.innerHTML = `
                <div style="width: 40px; height: 5px; background: #EEE; border-radius: 10px; margin: 0 auto 20px;"></div>
                <div style="text-align:center; padding:10px;">
                    <img src="https://images-eds-ssl.xboxlive.com/image?url=4rt9.lXDC4H_93laV1_eHHFT949fUipzkiFOBH3fAiZZUCdYojwUyX2aTonS1aIwMrx6NUIsHfUHSLzjGJFxxvtwvrt3JIhC0LNLrK_oJO8kh19fTjTSJb8vb7DjgYAi7LWZ0KeNOxyarooHGNzm8T0qE3e87NA38Ko.ME5t7Ag-&format=webp&h=210" style="width:70px; height:70px; border-radius:18px; margin-bottom:12px;">
                    <h2 style="font-size:22px; font-weight:800;">HBC-BORS</h2>
                    <p style="font-size:12px; color:#999; margin-bottom:32px;">湖北银行开门红数字化业绩中心</p>
                </div>
                <div style="background:#F2F2F7; padding:20px; border-radius:28px;">
                    <p style="font-size:13px; color:#666;">采用边缘加密存储逻辑。所有数据 100% 保存在您的本地浏览器中，确保数据合规、隐私无忧。</p>
                </div>
            `;
            document.getElementById('modal-overlay').classList.add('active');
        }

        function submitTransaction() {
            const tx = { id: Date.now(), customerId: document.getElementById('form-cust-id').value, bType: document.getElementById('form-type').value, amount: parseFloat(document.getElementById('form-amount').value || 0), date: document.getElementById('form-date').value, nature: document.getElementById('form-nature').value };
            if(!tx.customerId || tx.amount <= 0) return alert('请确保信息完整');
            transactions.push(tx); saveData(); switchTab('biz', document.querySelectorAll('.nav-item')[1]);
        }

        function switchTab(id, el) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`screen-${id}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            if(id === 'dashboard') renderDashboard();
            if(id === 'biz') renderBizList();
            if(id === 'cust') renderCustList();
        }

        function updateFormSelectors() {
            document.getElementById('form-cust-id').innerHTML = '<option value="">点击选择客户</option>' + customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        function closeModal(e) { if(e && e.target.id !== 'modal-overlay') return; document.getElementById('modal-overlay').classList.remove('active'); }
    </script>
</body>
</html>

